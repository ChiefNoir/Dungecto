<controls:MetroWindow
    x:Class="Dungecto.MainWindow"
    xmlns:controls="http://metro.mahapps.com/winfx/xaml/controls" 
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:res="clr-namespace:Dungecto.Properties"
    xmlns:view="clr-namespace:Dungecto.View"
    xmlns:ignore="http://www.ignore.com"
    mc:Ignorable="d ignore"
    Title="{x:Static res:Resources.AppName}"
    DataContext="{Binding Main, Source={StaticResource Locator}}"
    BorderBrush="{DynamicResource AccentColorBrush}"
    BorderThickness="1"
    Height="558.4" Width="1000.8" >

    <Window.Resources>
        <ResourceDictionary>
            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        </ResourceDictionary>
    </Window.Resources>

    <controls:MetroWindow.LeftWindowCommands>
        <controls:WindowCommands>
            <Button Content="{x:Static res:Resources.MainMenu}" Click="ShowHideMainMenu" />
        </controls:WindowCommands>
    </controls:MetroWindow.LeftWindowCommands>

    <Grid>

        <controls:Flyout x:Name="MainMenu" Header="{x:Static res:Resources.MainMenu}" Panel.ZIndex="100"
                         Position="Left" IsOpen="False"
                         Theme="Inverse" 
                         >
            <StackPanel>
                <Button Content="{x:Static res:Resources.MainMenuNew}" Margin="-1" Style="{DynamicResource SquareButtonStyle}" Command="{Binding CreateNewMapCommand}" />
                <Button Content="{x:Static res:Resources.MainMenuOpen}" Margin="-1" Style="{DynamicResource SquareButtonStyle}" Command="{Binding LoadMapCommand}" />
                <Button Content="{x:Static res:Resources.MainMenuSave}" Margin="-1" Style="{DynamicResource SquareButtonStyle}" Command="{Binding SaveMapCommand}" />
                <Button Content="{x:Static res:Resources.MainMenuExport}" Margin="-1" Style="{DynamicResource SquareButtonStyle}" Click="ExportMap" />
            </StackPanel>
        </controls:Flyout>


        <Grid >
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>



            <Expander Header="{x:Static res:Resources.Toolbox}" VerticalAlignment="Top" IsExpanded="True" Height="Auto"  >
                <ListView ItemsSource="{Binding Toolbox}" BorderBrush="Transparent" >
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <EventSetter Event="PreviewMouseLeftButtonDown" Handler="ListViewItem_PreviewMouseLeftButtonDown" />
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <ContentControl Width="50" Height="50" HorizontalContentAlignment="Center" >
                                <Path Data="{Binding Geometry}" Fill="{Binding Color}" Stretch="Fill" IsHitTestVisible="False" />
                            </ContentControl>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Expander>

            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" Grid.Column="1" >
                <ListView ItemsSource="{Binding Map.Tiles}" SelectedItem="{Binding SelectedTile}" BorderBrush="Transparent">
                    <ListView.Background>
                        <ImageBrush ImageSource="Assets/MapBackground.png"
                                        Viewport="0,0,16,16"
                                        ViewportUnits="Absolute"
                                        TileMode="Tile"
                                        Stretch="None"/>
                    </ListView.Background>
                    <ListView.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="{x:Static res:Resources.MapProperties}" />
                        </ContextMenu>
                    </ListView.ContextMenu>
                    <ListView.Resources>
                        <ContextMenu x:Key="ItemContextMenu">
                            <MenuItem Header="{x:Static res:Resources.Remove}" 
                                          Command="{Binding Path=DataContext.RemoveTileCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=ListView}}" Background="WhiteSmoke" />
                        </ContextMenu>
                    </ListView.Resources>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <Grid >

                                <view:ThumbMover Cursor="SizeAll" 
                                                    X="{Binding X, Mode=TwoWay}"
                                                    Y="{Binding Y, Mode=TwoWay}"
                                                     MinX="-5"
                                                     MinY="-2"
                                                    >
                                    <view:ThumbMover.Template>
                                        <ControlTemplate>
                                            <Rectangle Fill="Transparent"/>
                                        </ControlTemplate>
                                    </view:ThumbMover.Template>
                                </view:ThumbMover>

                                <Path 
                                      Width="{Binding Width}" Height="{Binding Height}" 
                                      Data="{Binding Geometry}" Fill="{Binding Color}" Stroke="Black" Stretch="Fill" IsHitTestVisible="False" />

                                <Grid 
                                        Visibility="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListBoxItem}}, Path=IsSelected, UpdateSourceTrigger=PropertyChanged, Mode=OneWay, Converter={StaticResource BoolToVis}}"
                                        >

                                    <view:TileResizer Height="3" Cursor="SizeNS" Margin="0,0,0,0" VerticalAlignment="Top" HorizontalAlignment="Stretch"/>
                                    <view:TileResizer Height="3" Cursor="SizeNS" Margin="0,0,0,0" VerticalAlignment="Bottom" HorizontalAlignment="Stretch"/>

                                    <view:TileResizer Width="3" Cursor="SizeWE" Margin="0,0,0,0" VerticalAlignment="Stretch" HorizontalAlignment="Left"/>
                                    <view:TileResizer Width="3" Cursor="SizeWE" Margin="0,0,0,0" VerticalAlignment="Stretch" HorizontalAlignment="Right"/>

                                    <view:TileResizer Width="8" Height="8" Cursor="SizeNWSE" Margin="0,0,0,0" VerticalAlignment="Top" HorizontalAlignment="Left"/>
                                    <view:TileResizer Width="8" Height="8" Cursor="SizeNESW" Margin="0,0,0,0" VerticalAlignment="Bottom" HorizontalAlignment="Left"/>

                                    <view:TileResizer Width="8" Height="8" Cursor="SizeNWSE" Margin="0,0,0,0" VerticalAlignment="Bottom" HorizontalAlignment="Right"/>
                                    <view:TileResizer Width="8" Height="8" Cursor="SizeNESW" Margin="0,0,0,0" VerticalAlignment="Top" HorizontalAlignment="Right"/>

                                </Grid>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>

                    <ListView.ItemContainerStyle>
                        <Style TargetType="{x:Type ListBoxItem}">
                            <Setter Property="Canvas.Top" Value="{Binding Path=Y}" />
                            <Setter Property="Canvas.Left" Value="{Binding Path=X}" />
                            <Setter Property="ContextMenu" Value="{StaticResource ItemContextMenu}" />
                        </Style>
                    </ListView.ItemContainerStyle>

                    <ListView.ItemsPanel>
                        <ItemsPanelTemplate>
                            <view:MapCanvas Margin="-5" Rows="{Binding Map.Rows}"
                                                Columns="{Binding Map.Columns}"
                                                SectorHeight="{Binding Map.SectorHeight}"
                                                SectorWidth="{Binding Map.SectorWidth}"
                                                Background="White" Drop="Canvas_Drop" AllowDrop="True" Loaded="ThumbListStack_Loaded" />
                        </ItemsPanelTemplate>
                    </ListView.ItemsPanel>

                </ListView>


            </ScrollViewer>

        </Grid>
    </Grid>
</controls:MetroWindow>
